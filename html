<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palopsee's Space Run</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            font-family: 'Pixelify Sans', 'Inter', sans-serif; 
            display: flex;
            flex-direction: column;
            align-items: center;
            /* justify-content: center; */ /* Adjusted for top icon */
            padding-top: 20px; /* Space for header icon */
            min-height: 100vh;
            margin: 0;
            color: #333; 
            overscroll-behavior-y: contain; 
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden; 
        }
        #headerLinkContainer {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
        }
        #headerPalopseeCanvas {
            border-radius: 4px; /* Optional: slightly rounded corners for the icon */
            /* box-shadow: 0 2px 4px rgba(0,0,0,0.1); */ /* Optional shadow */
        }
        canvas#gameCanvas { /* Specific to game canvas */
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            touch-action: none; 
            display: block; 
        }
        #messageBox {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4A90E2; 
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none; 
            font-size: 16px;
            font-family: 'Pixelify Sans', 'Inter', sans-serif; 
        }
        .light-theme {
            background-color: #ffffff;
            color: #333333;
        }
        .dark-theme {
            background-color: #121212;
            color: #DDDDDD;
        }
    </style>
</head>
<body>

    <div id="headerLinkContainer">
        <a id="headerLink" href="#" target="_blank" rel="noopener noreferrer">
            <canvas id="headerPalopseeCanvas"></canvas>
        </a>
    </div>

    <div id="messageBox"></div>
    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const headerPalopseeCanvas = document.getElementById('headerPalopseeCanvas');
        const headerPalopseeCtx = headerPalopseeCanvas.getContext('2d');
        const headerLink = document.getElementById('headerLink');

        const messageBox = document.getElementById('messageBox');
        const bodyElement = document.body;

        // --- Sound Effects Setup (Tone.js) ---
        let audioInitialized = false;
        let jumpSynth, scoreSynth, gameOverSynth, powerUpSynth;

        function initializeAudio() {
            if (Tone.context.state !== 'running') {
                Tone.start(); 
            }
            jumpSynth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 } }).toDestination();
            scoreSynth = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.05, sustain: 0, release: 0.1 } }).toDestination();
            gameOverSynth = new Tone.NoiseSynth({ noise: { type: 'brown' }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.1 } }).toDestination();
            powerUpSynth = new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination();
            audioInitialized = true;
        }
        
        function playJumpSound() { if (audioInitialized) {jumpSynth.volume.value = -12; jumpSynth.triggerAttackRelease('C5', '8n', Tone.now());} }
        function playScoreSound() { if (audioInitialized) {scoreSynth.volume.value = -18; scoreSynth.triggerAttackRelease('A5', '16n', Tone.now());} }
        function playGameOverSound() { if (audioInitialized) {gameOverSynth.volume.value = -8; gameOverSynth.triggerAttackRelease('16n', Tone.now());} }
        function playPowerUpSound() { if (audioInitialized) {powerUpSynth.volume.value = -10; powerUpSynth.triggerAttackRelease('G5', '8n', Tone.now());} }
        // --- End Sound Effects Setup ---


        // --- Theme Colors ---
        const themes = {
            light: { bodyBg: '#ffffff', bodyText: '#333333', canvasFallbackBg: '#ffffff', scoreText: '#333333', promptText: '#000000', promptBg: 'rgba(255, 255, 255, 0.7)', gameOverOverlay: 'rgba(0, 0, 0, 0.75)', gameOverMainText: '#FFFFFF', gameOverSubText: '#FFFFFF' },
            dark: { bodyBg: '#121212', bodyText: '#DDDDDD', canvasFallbackBg: '#222222', scoreText: '#DDDDDD', promptText: '#FFFFFF', promptBg: 'rgba(0, 0, 0, 0.5)', gameOverOverlay: 'rgba(255, 255, 255, 0.15)', gameOverMainText: '#FFFFFF', gameOverSubText: '#EEEEEE' }
        };
        let currentTheme = themes.light; 

        // --- Customizable Link URL ---
        let customHeaderLinkUrl = "#"; // <<<< REPLACE # WITH YOUR DESIRED URL >>>>
        // --- End Customizable Link URL ---

        // --- Customizable Image URLs ---
        let palopseeImageUrl = 'https://palopsee.netlify.app/palopsee.png'; 
        let backgroundImageUrl = 'https://palopsee.netlify.app/background.png'; 
        let asteroidImageUrl = 'https://placehold.co/32x32/A9A9A9/000000?text=O'; 
        let alienShipImageUrl = 'https://placehold.co/48x24/90EE90/000000?text=A'; 
        let powerUpImageUrl = 'https://placehold.co/24x24/FFD700/000000?text=S'; 
        // --- End Customizable Image URLs ---

        // --- Define Target Sizes for Game Elements ---
        const playerTargetWidth = 50; 
        const playerTargetHeight = 50;
        const asteroidTargetWidth = 32; 
        const asteroidTargetHeight = 32;
        const alienShipTargetWidth = 48; 
        const alienShipTargetHeight = 24;
        const powerUpTargetWidth = 24;   
        const powerUpTargetHeight = 24;
        const headerPalopseeTargetWidth = 40; // Size for the top icon
        const headerPalopseeTargetHeight = 40;
        // --- End Target Sizes ---

        // --- Define Target Size for Background Tiles ---
        const backgroundTileWidth = 200; 
        const backgroundTileHeight = 150; 
        // --- End Background Tile Size ---


        let palopseeImg = new Image();
        let asteroidImg = new Image();
        let alienShipImg = new Image();
        let powerUpImg = new Image();
        let bgImg = new Image(); 
        let bgPatternCanvas = null; 
        let backgroundPattern = null; 
        let backgroundOffsetX = 0; 

        let palopseeBufferCanvas = null; 
        let palopseeBufferCtx = null;
        let headerPalopseeBufferCanvas = null; // Buffer for the header icon
        let headerPalopseeBufferCtx = null;


        let imagesLoaded = 0;
        const totalImages = 5; 

        // Game variables
        const highScoreKey = 'palopseeGameHighScore'; 
        let score = 0;
        let previousScoreForSound = 0; 
        const scoreMilestoneInterval = 100; 
        let powerUpSpawnedForCurrentMilestone = false; 
        let highScore = 0;
        let gameSpeed = 5;
        let gameSpeedIncreaseFactor = 0.002;
        let gameOver = false;
        let gameStarted = false;
        let animationFrameId;

        const groundHeight = 50; 
        let canvasWidth = 800; 
        let canvasHeight = 300; 
        const designAspectRatio = canvasWidth / canvasHeight;

        const gameFont = "'Pixelify Sans', 'Inter', sans-serif"; 

        // Player (Palopsee) properties
        const player = {
            x: 50,
            y: canvasHeight - groundHeight - playerTargetHeight,
            width: playerTargetWidth,  
            height: playerTargetHeight, 
            dy: 0, 
            jumpStrength: 12,
            gravity: 0.7,
            isJumping: false,
            groundY: canvasHeight - groundHeight - playerTargetHeight,
            isInvincible: false, 
            invincibilityFrames: 0, 
            draw() {
                if (palopseeImg.complete && palopseeImg.naturalWidth > 0) {
                    if (this.isInvincible) {
                        this.invincibilityFrames++;
                        if (this.invincibilityFrames % 10 < 5) { 
                            return; 
                        }
                    }

                    if (currentTheme === themes.dark) {
                        if (!palopseeBufferCanvas || palopseeBufferCanvas.width !== this.width || palopseeBufferCanvas.height !== this.height) {
                            palopseeBufferCanvas = document.createElement('canvas');
                            palopseeBufferCanvas.width = this.width;
                            palopseeBufferCanvas.height = this.height;
                            palopseeBufferCtx = palopseeBufferCanvas.getContext('2d');
                        }
                        palopseeBufferCtx.clearRect(0, 0, this.width, this.height); 
                        palopseeBufferCtx.filter = 'invert(1)'; 
                        palopseeBufferCtx.drawImage(palopseeImg, 0, 0, this.width, this.height);
                        palopseeBufferCtx.filter = 'none'; 
                        ctx.drawImage(palopseeBufferCanvas, this.x, this.y, this.width, this.height);
                    } else {
                        ctx.drawImage(palopseeImg, this.x, this.y, this.width, this.height);
                    }
                } else {
                    ctx.fillStyle = currentTheme.scoreText; 
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                }
            },
            jump() {
                if (!this.isJumping && !gameOver && gameStarted) { 
                    this.isJumping = true;
                    this.dy = -this.jumpStrength;
                    playJumpSound(); 
                }
            },
            update() {
                if (this.isJumping) {
                    this.y += this.dy;
                    this.dy += this.gravity;
                }
                if (this.y + this.height >= this.groundY + this.height) {
                    this.y = this.groundY;
                    this.isJumping = false;
                    this.dy = 0;
                }
            }
        };

        let obstacles = [];
        let powerUps = []; 

        function createObstacle() {
            const obstacleType = Math.random() < 0.6 ? 'asteroid' : 'alienShip'; 
            let img, width, height, yPos;

            if (obstacleType === 'asteroid') {
                img = asteroidImg;
                width = asteroidTargetWidth; 
                height = asteroidTargetHeight; 
                yPos = canvasHeight - groundHeight - height;
            } else { // alienShip
                img = alienShipImg;
                width = alienShipTargetWidth; 
                height = alienShipTargetHeight; 
                
                const alienShipClearance = 5 + player.height * 0.2; 
                yPos = player.groundY - alienShipClearance - height;

                if (yPos < 10) yPos = 10; 
                if (yPos + height > canvasHeight - groundHeight - player.height / 2) { 
                    yPos = player.groundY - alienShipClearance - height; 
                }
            }

            const newObstacle = { 
                x: canvasWidth, y: yPos, width, height, type: obstacleType, image: img, 
                draw() { 
                    if (this.image.complete && this.image.naturalWidth > 0) {
                        ctx.drawImage(this.image, this.x, this.y, this.width, this.height); 
                    } else {
                        ctx.fillStyle = (this.type === 'asteroid') ? '#A9A9A9' : '#90EE90'; 
                        ctx.fillRect(this.x, this.y, this.width, this.height);
                    }
                }, 
                update() { this.x -= gameSpeed; } 
            };
            obstacles.push(newObstacle);
        }

        function createPowerUp() {
            const newPowerUp = {
                x: canvasWidth,
                y: canvasHeight - groundHeight - powerUpTargetHeight - (Math.random() * (player.height + 20)), 
                width: powerUpTargetWidth,
                height: powerUpTargetHeight,
                image: powerUpImg,
                draw() { 
                     if (this.image.complete && this.image.naturalWidth > 0) {
                        ctx.drawImage(this.image, this.x, this.y, this.width, this.height); 
                     } else {
                        ctx.fillStyle = '#FFD700'; 
                        ctx.fillRect(this.x, this.y, this.width, this.height);
                     }
                },
                update() { this.x -= gameSpeed; }
            };
            if (newPowerUp.y < player.height) newPowerUp.y = player.height + 10; 

            powerUps.push(newPowerUp);
        }

        function handleObstacles() {
            const spawnMinDistance = canvasWidth * 0.4 + gameSpeed * 10; 
            const spawnRandomDistance = canvasWidth * 0.3;

            if (obstacles.length === 0 || obstacles[obstacles.length - 1].x < canvasWidth - spawnMinDistance - Math.random() * spawnRandomDistance) {
                 if (Math.random() < (0.015 + gameSpeed * 0.0005) && gameStarted) { 
                    createObstacle();
                 }
            }

            for (let i = obstacles.length - 1; i >= 0; i--) {
                const obs = obstacles[i];
                obs.update();
                obs.draw();

                let collided = false;
                if (
                    player.x < obs.x + obs.width && player.x + player.width > obs.x &&
                    player.y < obs.y + obs.height && player.y + player.height > obs.y
                ) {
                    if (obs.type === 'asteroid') {
                        collided = true;
                    } else if (obs.type === 'alienShip') {
                        if (player.isJumping) { 
                            collided = true;
                        }
                    }
                }

                if (collided && !player.isInvincible) { 
                    setGameOver();
                    return; 
                }

                if (obs.x + obs.width < 0) {
                    obstacles.splice(i, 1);
                    if (!gameOver) {
                        score++;
                        if (score > 0 && score % scoreMilestoneInterval === 0 && score !== previousScoreForSound) {
                            playScoreSound();
                            previousScoreForSound = score; 
                        }
                        if (score % scoreMilestoneInterval !== 0) {
                            powerUpSpawnedForCurrentMilestone = false;
                        }
                    }
                }
            }
        }

        function handlePowerUps() {
            if (gameStarted && powerUps.length === 0 && 
                score > 0 && score % scoreMilestoneInterval === 0 && 
                !powerUpSpawnedForCurrentMilestone) {
                createPowerUp();
                powerUpSpawnedForCurrentMilestone = true; 
            }

            for (let i = powerUps.length - 1; i >= 0; i--) {
                const pUp = powerUps[i];
                pUp.update();
                pUp.draw();

                if (
                    player.x < pUp.x + pUp.width && player.x + player.width > pUp.x &&
                    player.y < pUp.y + pUp.height && player.y + player.height > pUp.y
                ) {
                    player.isInvincible = true;
                    player.invincibilityFrames = 0; 
                    playPowerUpSound();
                    powerUps.splice(i, 1); 
                    setTimeout(() => {
                        player.isInvincible = false;
                    }, 5000); 
                }

                if (pUp.x + pUp.width < 0) {
                    powerUps.splice(i, 1); 
                }
            }
        }
        
        function drawBackgroundImage(){if(backgroundPattern&&bgPatternCanvas){ctx.save();ctx.globalAlpha=.1;let e=backgroundOffsetX%bgPatternCanvas.width;e>0&&(e-=bgPatternCanvas.width);ctx.translate(e,0);ctx.fillStyle=backgroundPattern;ctx.fillRect(0,0,canvasWidth+bgPatternCanvas.width,canvasHeight);ctx.restore()}else if(bgImg.complete&&bgImg.naturalWidth>0){bgPatternCanvas||createBackgroundPatternTile();bgPatternCanvas&&!backgroundPattern&&createActualPattern();if(backgroundPattern&&bgPatternCanvas){ctx.save();ctx.globalAlpha=.1;let e=backgroundOffsetX%bgPatternCanvas.width;e>0&&(e-=bgPatternCanvas.width);ctx.translate(e,0);ctx.fillStyle=backgroundPattern;ctx.fillRect(0,0,canvasWidth+bgPatternCanvas.width,canvasHeight);ctx.restore()}else{ctx.save();ctx.globalAlpha=.1;ctx.drawImage(bgImg,0,0,canvasWidth,canvasHeight);ctx.restore()}}else{ctx.fillStyle=currentTheme.canvasFallbackBg;ctx.fillRect(0,0,canvasWidth,canvasHeight)}}
        function drawGround(){}
        function showMessage(e,t=3e3){messageBox.textContent=e;messageBox.style.display="block";setTimeout(()=>{messageBox.style.display="none"},t)}
        function createBackgroundPatternTile(){if(bgImg.complete&&bgImg.naturalWidth>0){bgPatternCanvas=document.createElement("canvas");bgPatternCanvas.width=backgroundTileWidth;bgPatternCanvas.height=backgroundTileHeight;const e=bgPatternCanvas.getContext("2d");e.drawImage(bgImg,0,0,backgroundTileWidth,backgroundTileHeight)}else bgPatternCanvas=null}
        function createActualPattern(){if(bgPatternCanvas)backgroundPattern=ctx.createPattern(bgPatternCanvas,"repeat");else backgroundPattern=null}

        function drawHeaderPalopsee() {
            if (!headerPalopseeCtx || !palopseeImg.complete || palopseeImg.naturalWidth === 0) {
                // Draw a fallback if image not ready or canvas context not available
                if(headerPalopseeCtx) {
                    headerPalopseeCtx.fillStyle = currentTheme.canvasFallbackBg;
                    headerPalopseeCtx.fillRect(0, 0, headerPalopseeTargetWidth, headerPalopseeTargetHeight);
                }
                return;
            }

            headerPalopseeCtx.clearRect(0, 0, headerPalopseeTargetWidth, headerPalopseeTargetHeight);

            if (currentTheme === themes.dark) {
                if (!headerPalopseeBufferCanvas || headerPalopseeBufferCanvas.width !== headerPalopseeTargetWidth || headerPalopseeBufferCanvas.height !== headerPalopseeTargetHeight) {
                    headerPalopseeBufferCanvas = document.createElement('canvas');
                    headerPalopseeBufferCanvas.width = headerPalopseeTargetWidth;
                    headerPalopseeBufferCanvas.height = headerPalopseeTargetHeight;
                    headerPalopseeBufferCtx = headerPalopseeBufferCanvas.getContext('2d');
                }
                headerPalopseeBufferCtx.clearRect(0, 0, headerPalopseeTargetWidth, headerPalopseeTargetHeight);
                headerPalopseeBufferCtx.filter = 'invert(1)';
                headerPalopseeBufferCtx.drawImage(palopseeImg, 0, 0, headerPalopseeTargetWidth, headerPalopseeTargetHeight);
                headerPalopseeBufferCtx.filter = 'none';
                headerPalopseeCtx.drawImage(headerPalopseeBufferCanvas, 0, 0, headerPalopseeTargetWidth, headerPalopseeTargetHeight);
            } else {
                headerPalopseeCtx.drawImage(palopseeImg, 0, 0, headerPalopseeTargetWidth, headerPalopseeTargetHeight);
            }
        }


        function setGameOver() {
            gameOver = true;
            gameStarted = false;
            player.isInvincible = false; 
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            playGameOverSound(); 
            drawBackgroundImage(); 

            ctx.fillStyle = currentTheme.gameOverOverlay; 
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);
            ctx.font = `40px ${gameFont}`; 
            ctx.fillStyle = currentTheme.gameOverMainText; 
            ctx.textAlign = 'center';
            ctx.fillText('Game Over!', canvasWidth / 2, canvasHeight / 2 - 30);
            ctx.font = `20px ${gameFont}`; 
            ctx.fillStyle = currentTheme.gameOverSubText; 
            ctx.fillText(`Score: ${score}`, canvasWidth / 2, canvasHeight / 2 + 10);
            
            if (score > highScore) {
                highScore = score;
                localStorage.setItem(highScoreKey, highScore); 
                ctx.fillText(`New High Score! ${highScore}`, canvasWidth / 2, canvasHeight / 2 + 40);
            } else {
                ctx.fillText(`High Score: ${highScore}`, canvasWidth / 2, canvasHeight / 2 + 40);
            }

            ctx.font = `16px ${gameFont}`; 
            ctx.fillText('Tap or Press Space/Up to Restart', canvasWidth / 2, canvasHeight / 2 + 70);
        }

        function resetGame() {
            score = 0;
            previousScoreForSound = 0; 
            powerUpSpawnedForCurrentMilestone = false; 
            gameSpeed = 5; 
            gameOver = false;
            gameStarted = false; 
            obstacles = [];
            powerUps = []; 
            
            player.dy = 0;
            player.isJumping = false;
            player.isInvincible = false;
            
            messageBox.style.display = 'none';
            
            imagesLoaded = 0; 
            bgPatternCanvas = null; 
            backgroundPattern = null; 
            backgroundOffsetX = 0; 
            
            palopseeImg.src = ""; palopseeImg.src = palopseeImageUrl;
            asteroidImg.src = ""; asteroidImg.src = asteroidImageUrl;
            alienShipImg.src = ""; alienShipImg.src = alienShipImageUrl;
            powerUpImg.src = ""; powerUpImg.src = powerUpImageUrl;
            bgImg.src = ""; bgImg.src = backgroundImageUrl;
        }
        
        function gameLoop() {
            if (gameOver) return;

            ctx.clearRect(0, 0, canvasWidth, canvasHeight); 
            
            backgroundOffsetX -= gameSpeed;
            if (bgPatternCanvas && bgPatternCanvas.width > 0) {
                 if (backgroundOffsetX <= -bgPatternCanvas.width) {
                    backgroundOffsetX += bgPatternCanvas.width; 
                }
            }

            drawBackgroundImage(); 
            drawGround(); 
            player.update();
            player.draw();
            handleObstacles();
            handlePowerUps(); 
            
            ctx.font = `16px ${gameFont}`; 
            ctx.fillStyle = currentTheme.scoreText; 
            ctx.textAlign = 'left';
            ctx.fillText(`Score: ${score}`, 10, 25); 

            gameSpeed += gameSpeedIncreaseFactor; 
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function onImageLoad() {
            imagesLoaded++;
            if (this === bgImg && this.complete && this.naturalWidth > 0) {
                createBackgroundPatternTile();
                createActualPattern(); 
            }
            if (this === palopseeImg && this.complete && this.naturalWidth > 0) {
                drawHeaderPalopsee(); // Draw header icon once Palopsee image is loaded
            }


            if (imagesLoaded === totalImages) {
                if (!gameStarted && !gameOver) {
                    showMessage('Ready to Fly!', 2000);
                } else if (gameOver) {
                    setGameOver(); 
                }
                 resizeCanvas(); 
            }
        }

        function onImageError(e) { console.error("Error loading image:", e.target.src); onImageLoad(); }
        
        function startGameActions() {
            if (!audioInitialized) { 
                initializeAudio();
            }
            if (gameOver) { resetGame(); return; }
            if (!gameStarted && imagesLoaded === totalImages) {
                gameStarted = true;
                if (animationFrameId) cancelAnimationFrame(animationFrameId); 
                gameLoop();
            }
            player.jump();
        }

        window.addEventListener('keydown', (e) => { if ((e.code === 'Space' || e.code === 'ArrowUp')) { e.preventDefault(); startGameActions(); } });
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startGameActions(); }, { passive: false }); 

        function applyTheme(isDark) { 
            currentTheme = isDark ? themes.dark : themes.light; 
            bodyElement.className = isDark ? 'dark-theme' : 'light-theme'; 
            drawHeaderPalopsee(); // Redraw header icon with new theme
            resizeCanvas(); 
        }
        const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        darkModeMediaQuery.addEventListener('change', (e) => applyTheme(e.matches));

        function resizeCanvas() {
            let newWidth = window.innerWidth;
            let newHeight = newWidth / designAspectRatio;

            canvas.width = newWidth;
            canvas.height = newHeight;
            canvasWidth = newWidth; 
            canvasHeight = newHeight;

            player.groundY = canvas.height - groundHeight - player.height; 
            if (!player.isJumping || !gameStarted) { player.y = player.groundY; }

            obstacles.forEach(obs => {
                if (obs.type === 'asteroid') {
                    obs.y = canvas.height - groundHeight - obs.height; 
                } else if (obs.type === 'alienShip') {
                    const alienShipClearance = 5 + player.height * 0.2; 
                    obs.y = player.groundY - alienShipClearance - obs.height; 
                    if (obs.y < 10) obs.y = 10;
                }
            });
             powerUps.forEach(pUp => { 
                pUp.y = Math.max(player.height + 10, Math.min(pUp.y, canvas.height - groundHeight - pUp.height - 10));
            });


            if (bgImg.complete && bgImg.naturalWidth > 0) { createBackgroundPatternTile(); createActualPattern(); }
            ctx.clearRect(0,0,canvas.width,canvas.height); drawBackgroundImage(); drawGround(); player.draw(); obstacles.forEach(o=>o.draw()); powerUps.forEach(p=>p.draw());
            if(!gameOver){ctx.font=`16px ${gameFont}`;ctx.fillStyle=currentTheme.scoreText;ctx.textAlign="left";ctx.fillText(`Score: ${score}`,10,25)}
            if(gameOver){setGameOver()}else if(!gameStarted&&imagesLoaded===totalImages){ctx.font=`20px ${gameFont}`;ctx.textAlign="center";const e="Tap Screen or Press Space/Up to Start!",t=ctx.measureText(e).width,i=parseInt(ctx.font,10)*1.2;ctx.fillStyle=currentTheme.promptBg;ctx.fillRect(canvas.width/2-t/2-10,canvas.height/2-i,t+20,i+10);ctx.fillStyle=currentTheme.promptText;ctx.fillText(e,canvas.width/2,canvas.height/2-i/2+5)}else if(!gameStarted&&imagesLoaded<totalImages){ctx.font=`20px ${gameFont}`;ctx.textAlign="center";const e="Loading Assets...",t=ctx.measureText(e).width,i=parseInt(ctx.font,10)*1.2;ctx.fillStyle=currentTheme.promptBg;ctx.fillRect(canvas.width/2-t/2-10,canvas.height/2-i,t+20,i+10);ctx.fillStyle=currentTheme.promptText;ctx.fillText(e,canvas.width/2,canvas.height/2-i/2+5)}
             drawHeaderPalopsee(); // Ensure header is redrawn on resize too
        }
        
        window.addEventListener('resize', resizeCanvas);

        function initGame() {
            headerLink.href = customHeaderLinkUrl; // Set the custom link URL
            headerPalopseeCanvas.width = headerPalopseeTargetWidth;
            headerPalopseeCanvas.height = headerPalopseeTargetHeight;


            const savedHighScore = localStorage.getItem(highScoreKey);
            if (savedHighScore) { highScore = parseInt(savedHighScore, 10); }

            player.width = playerTargetWidth;
            player.height = playerTargetHeight;
            player.groundY = canvasHeight - groundHeight - player.height; 
            player.y = player.groundY; 

            if (!palopseeBufferCanvas) {
                palopseeBufferCanvas = document.createElement('canvas');
                palopseeBufferCanvas.width = player.width;
                palopseeBufferCanvas.height = player.height;
                palopseeBufferCtx = palopseeBufferCanvas.getContext('2d');
            }
            if (!headerPalopseeBufferCanvas) { // Initialize buffer for header icon
                headerPalopseeBufferCanvas = document.createElement('canvas');
                headerPalopseeBufferCanvas.width = headerPalopseeTargetWidth;
                headerPalopseeBufferCanvas.height = headerPalopseeTargetHeight;
                headerPalopseeBufferCtx = headerPalopseeBufferCanvas.getContext('2d');
            }


            palopseeImg.onload = onImageLoad;
            asteroidImg.onload = onImageLoad;
            alienShipImg.onload = onImageLoad; 
            powerUpImg.onload = onImageLoad; 
            bgImg.onload = onImageLoad; 

            palopseeImg.onerror = onImageError;
            asteroidImg.onerror = onImageError;
            alienShipImg.onerror = onImageError;
            powerUpImg.onerror = onImageError; 
            bgImg.onerror = onImageError; 

            palopseeImg.src = palopseeImageUrl;
            asteroidImg.src = asteroidImageUrl;
            alienShipImg.src = alienShipImageUrl;
            powerUpImg.src = powerUpImageUrl; 
            bgImg.src = backgroundImageUrl; 
            
            applyTheme(darkModeMediaQuery.matches); 
        }

        initGame(); 
    </script>
</body>
</html>
