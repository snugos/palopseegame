<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palopsee's Space Run</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            font-family: 'Pixelify Sans', 'Inter', sans-serif; 
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px; 
            min-height: 100vh;
            margin: 0;
            color: #333; 
            overscroll-behavior-y: contain; 
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow: hidden; /* Prevent scrollbars from canvas edges */
        }
        #backgroundCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1; /* Behind all other content */
        }
        #headerLinkContainer {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            position: relative; /* Ensure it's above the fixed background */
            z-index: 1;
        }
        #headerPalopseeCanvas {
            border-radius: 4px; 
            cursor: pointer;
        }
        canvas#gameCanvas { 
            border-radius: 8px;
            /* box-shadow: 0 4px 8px rgba(0,0,0,0.1); */ /* Removed box-shadow */
            touch-action: none; 
            display: block; 
            position: relative; /* Ensure it's above the fixed background */
            z-index: 0;
        }
        #messageBox {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4A90E2; 
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none; 
            font-size: 16px;
            font-family: 'Pixelify Sans', 'Inter', sans-serif; 
        }
        .light-theme {
            background-color: #ffffff;
            color: #333333;
        }
        .dark-theme {
            background-color: #121212;
            color: #DDDDDD;
        }
    </style>
</head>
<body>

    <canvas id="backgroundCanvas"></canvas>

    <div id="headerLinkContainer">
        <a id="headerLink" href="#" target="_blank" rel="noopener noreferrer">
            <canvas id="headerPalopseeCanvas"></canvas>
        </a>
    </div>

    <div id="messageBox"></div>
    <canvas id="gameCanvas"></canvas>

    <script>
        // ======================================================================
        // Palopsee's Space Run - Final Version
        // ======================================================================
        //
        // To customize this game further, you can change the URLs below for
        // Palopsee's images, the obstacles, the power-up, and the background.
        // You can also update the 'customHeaderLinkUrl' to point the top
        // Palopsee icon to your desired webpage.
        //
        // Remember to use 8-bit style images for a consistent look!
        // Transparent backgrounds (PNG) are recommended for game elements.
        //
        // ======================================================================

        const gameCanvas = document.getElementById('gameCanvas');
        const ctx = gameCanvas.getContext('2d');
        const backgroundCanvas = document.getElementById('backgroundCanvas');
        const bgCtx = backgroundCanvas.getContext('2d'); 

        const headerPalopseeCanvas = document.getElementById('headerPalopseeCanvas');
        const headerPalopseeCtx = headerPalopseeCanvas.getContext('2d');
        const headerLink = document.getElementById('headerLink');
        const headerLinkContainer = document.getElementById('headerLinkContainer');


        const messageBox = document.getElementById('messageBox');
        const bodyElement = document.body;

        // --- Sound Effects Setup (Tone.js) ---
        let audioInitialized = false;
        let jumpSynth, scoreSynth, gameOverSynth, powerUpSynth;

        function initializeAudio() {
            if (Tone.context.state !== 'running') {
                Tone.start(); 
            }
            jumpSynth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 } }).toDestination();
            scoreSynth = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.05, sustain: 0, release: 0.1 } }).toDestination();
            gameOverSynth = new Tone.NoiseSynth({ noise: { type: 'brown' }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.1 } }).toDestination();
            powerUpSynth = new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination();
            audioInitialized = true;
        }
        
        function playJumpSound() { if (audioInitialized) {jumpSynth.volume.value = -12; jumpSynth.triggerAttackRelease('C5', '8n', Tone.now());} }
        function playScoreSound() { if (audioInitialized) {scoreSynth.volume.value = -18; scoreSynth.triggerAttackRelease('A5', '16n', Tone.now());} }
        function playGameOverSound() { if (audioInitialized) {gameOverSynth.volume.value = -8; gameOverSynth.triggerAttackRelease('16n', Tone.now());} }
        function playPowerUpSound() { if (audioInitialized) {powerUpSynth.volume.value = -10; powerUpSynth.triggerAttackRelease('G5', '8n', Tone.now());} }
        // --- End Sound Effects Setup ---


        // --- Theme Colors ---
        const themes = {
            light: { bodyBg: '#ffffff', bodyText: '#333333', canvasFallbackBg: '#ffffff', scoreText: '#333333', promptText: '#000000', promptBg: 'rgba(255, 255, 255, 0.7)', gameOverOverlay: 'rgba(0, 0, 0, 0.75)', gameOverMainText: '#FFFFFF', gameOverSubText: '#FFFFFF' },
            dark: { bodyBg: '#121212', bodyText: '#DDDDDD', canvasFallbackBg: '#222222', scoreText: '#DDDDDD', promptText: '#FFFFFF', promptBg: 'rgba(0, 0, 0, 0.5)', gameOverOverlay: 'rgba(255, 255, 255, 0.15)', gameOverMainText: '#FFFFFF', gameOverSubText: '#EEEEEE' }
        };
        let currentTheme = themes.light; 
        let isDarkMode = false; 

        // --- Customizable Link URL ---
        let customHeaderLinkUrl = "#"; // <<<< REPLACE # WITH YOUR DESIRED URL for the top Palopsee icon >>>>
        // --- End Customizable Link URL ---

        // --- Customizable Image URLs ---
        // Replace these placeholder URLs with your actual 8-bit sprite URLs!
        let palopseeImageUrl = 'https://palopsee.netlify.app/palopsee.png'; 
        let palopseeDarkImageUrl = 'https://palopsee.netlify.app/palopsee-modified.png';
        let backgroundImageUrl = 'https://palopsee.netlify.app/background.png'; 
        let asteroidImageUrl = 'https://placehold.co/32x32/A9A9A9/000000?text=O'; // Placeholder for your 8-bit asteroid
        let alienShipImageUrl = 'https://placehold.co/48x24/90EE90/000000?text=A'; // Placeholder for your 8-bit alien ship
        let powerUpImageUrl = 'https://placehold.co/24x24/FFD700/000000?text=S'; // Placeholder for your 8-bit star
        // --- End Customizable Image URLs ---

        // --- Define Target Sizes for Game Elements ---
        const playerTargetWidth = 50; 
        const playerTargetHeight = 50;
        const asteroidTargetWidth = 32; 
        const asteroidTargetHeight = 32;
        const alienShipTargetWidth = 48; 
        const alienShipTargetHeight = 24;
        const powerUpTargetWidth = 24;   
        const powerUpTargetHeight = 24;
        const headerPalopseeTargetWidth = 40; 
        const headerPalopseeTargetHeight = 40;
        // --- End Target Sizes ---

        // --- Define Target Size for Background Tiles ---
        const backgroundTileWidth = 200; 
        const backgroundTileHeight = 150; 
        // --- End Background Tile Size ---


        let palopseeImg = new Image();
        let palopseeDarkImg = new Image(); 
        let asteroidImg = new Image();
        let alienShipImg = new Image();
        let powerUpImg = new Image();
        let bgImg = new Image(); 
        let bgPatternCanvas = null; 
        let backgroundPattern = null; 
        let backgroundOffsetX = 0; 

        let imagesLoaded = 0;
        const totalImages = 6; // Palopsee, PalopseeDark, Asteroid, AlienShip, PowerUp, Background

        // Game variables
        const highScoreKey = 'palopseeGameHighScore'; 
        let score = 0;
        let previousScoreForSound = 0; 
        const scoreMilestoneInterval = 30; 
        let powerUpSpawnedForCurrentMilestone = false; 
        let highScore = 0;
        let gameSpeed = 5;
        let gameSpeedIncreaseFactor = 0.002;
        let gameOver = false;
        let gameStarted = false;
        let animationFrameId;

        const groundHeight = 50; 
        let gameCanvasWidth = 800; 
        let gameCanvasHeight = 300; 
        const designAspectRatio = gameCanvasWidth / gameCanvasHeight;

        const gameFont = "'Pixelify Sans', 'Inter', sans-serif"; 

        // Player (Palopsee) properties
        const player = {
            x: 50,
            y: gameCanvasHeight - groundHeight - playerTargetHeight,
            width: playerTargetWidth,  
            height: playerTargetHeight, 
            dy: 0, 
            jumpStrength: 12,
            gravity: 0.7,
            isJumping: false,
            groundY: gameCanvasHeight - groundHeight - playerTargetHeight,
            isInvincible: false, 
            invincibilityFrames: 0, 
            draw() {
                let currentPalopseeImageToDraw = isDarkMode ? palopseeDarkImg : palopseeImg;

                // Ensure the selected image is loaded before trying to draw
                if (currentPalopseeImageToDraw.complete && currentPalopseeImageToDraw.naturalWidth > 0) {
                    if (this.isInvincible) {
                        this.invincibilityFrames++;
                        if (this.invincibilityFrames % 10 < 5) { 
                            return; 
                        }
                    }
                    ctx.drawImage(currentPalopseeImageToDraw, this.x, this.y, this.width, this.height);
                } else {
                    // Fallback if the specific theme image isn't ready, try the default light mode one
                    if (palopseeImg.complete && palopseeImg.naturalWidth > 0) {
                         ctx.drawImage(palopseeImg, this.x, this.y, this.width, this.height);
                    } else { // Ultimate fallback: a colored rectangle
                        ctx.fillStyle = currentTheme.scoreText; 
                        ctx.fillRect(this.x, this.y, this.width, this.height);
                    }
                }
            },
            jump() {
                if (!this.isJumping && !gameOver && gameStarted) { 
                    this.isJumping = true;
                    this.dy = -this.jumpStrength;
                    playJumpSound(); 
                }
            },
            update() {
                if (this.isJumping) {
                    this.y += this.dy;
                    this.dy += this.gravity;
                }
                if (this.y + this.height >= this.groundY + this.height) {
                    this.y = this.groundY;
                    this.isJumping = false;
                    this.dy = 0;
                }
            }
        };

        let obstacles = [];
        let powerUps = []; 

        function createObstacle() {
            const obstacleType = Math.random() < 0.6 ? 'asteroid' : 'alienShip'; 
            let img, width, height, yPos;

            if (obstacleType === 'asteroid') {
                img = asteroidImg;
                width = asteroidTargetWidth; 
                height = asteroidTargetHeight; 
                yPos = gameCanvasHeight - groundHeight - height;
            } else { // alienShip
                img = alienShipImg;
                width = alienShipTargetWidth; 
                height = alienShipTargetHeight; 
                
                const alienShipClearance = 5 + player.height * 0.2; 
                yPos = player.groundY - alienShipClearance - height;

                if (yPos < 10) yPos = 10; 
                if (yPos + height > gameCanvasHeight - groundHeight - player.height / 2) { 
                    yPos = player.groundY - alienShipClearance - height; 
                }
            }

            const newObstacle = { 
                x: gameCanvasWidth, y: yPos, width, height, type: obstacleType, image: img, 
                draw() { 
                    if (this.image.complete && this.image.naturalWidth > 0) {
                        ctx.drawImage(this.image, this.x, this.y, this.width, this.height); 
                    } else {
                        ctx.fillStyle = (this.type === 'asteroid') ? '#A9A9A9' : '#90EE90'; 
                        ctx.fillRect(this.x, this.y, this.width, this.height);
                    }
                }, 
                update() { this.x -= gameSpeed; } 
            };
            obstacles.push(newObstacle);
        }

        function createPowerUp() {
            const newPowerUp = {
                x: gameCanvasWidth,
                y: gameCanvasHeight - groundHeight - powerUpTargetHeight - (Math.random() * (player.height + 20)), 
                width: powerUpTargetWidth,
                height: powerUpTargetHeight,
                image: powerUpImg,
                draw() { 
                     if (this.image.complete && this.image.naturalWidth > 0) {
                        ctx.drawImage(this.image, this.x, this.y, this.width, this.height); 
                     } else {
                        ctx.fillStyle = '#FFD700'; 
                        ctx.fillRect(this.x, this.y, this.width, this.height);
                     }
                },
                update() { this.x -= gameSpeed; }
            };
            if (newPowerUp.y < player.height) newPowerUp.y = player.height + 10; 

            powerUps.push(newPowerUp);
        }

        function handleObstacles() {
            const spawnMinDistance = gameCanvasWidth * 0.4 + gameSpeed * 10; 
            const spawnRandomDistance = gameCanvasWidth * 0.3;

            if (obstacles.length === 0 || obstacles[obstacles.length - 1].x < gameCanvasWidth - spawnMinDistance - Math.random() * spawnRandomDistance) {
                 if (Math.random() < (0.015 + gameSpeed * 0.0005) && gameStarted) { 
                    createObstacle();
                 }
            }

            for (let i = obstacles.length - 1; i >= 0; i--) {
                const obs = obstacles[i];
                obs.update();
                obs.draw();

                let collided = false;
                if (
                    player.x < obs.x + obs.width && player.x + player.width > obs.x &&
                    player.y < obs.y + obs.height && player.y + player.height > obs.y
                ) {
                    if (obs.type === 'asteroid') {
                        collided = true;
                    } else if (obs.type === 'alienShip') {
                        if (player.isJumping) { 
                            collided = true;
                        }
                    }
                }

                if (collided && !player.isInvincible) { 
                    setGameOver();
                    return; 
                }

                if (obs.x + obs.width < 0) {
                    obstacles.splice(i, 1);
                    if (!gameOver) {
                        score++;
                        if (score > 0 && score % scoreMilestoneInterval === 0 && score !== previousScoreForSound) {
                            playScoreSound();
                            previousScoreForSound = score; 
                        }
                        if (score % scoreMilestoneInterval !== 0) {
                            powerUpSpawnedForCurrentMilestone = false;
                        }
                    }
                }
            }
        }

        function handlePowerUps() {
            if (gameStarted && powerUps.length === 0 && 
                score > 0 && score % scoreMilestoneInterval === 0 && 
                !powerUpSpawnedForCurrentMilestone) {
                createPowerUp();
                powerUpSpawnedForCurrentMilestone = true; 
            }

            for (let i = powerUps.length - 1; i >= 0; i--) {
                const pUp = powerUps[i];
                pUp.update();
                pUp.draw();

                if (
                    player.x < pUp.x + pUp.width && player.x + player.width > pUp.x &&
                    player.y < pUp.y + pUp.height && player.y + player.height > pUp.y
                ) {
                    player.isInvincible = true;
                    player.invincibilityFrames = 0; 
                    playPowerUpSound();
                    powerUps.splice(i, 1); 
                    setTimeout(() => {
                        player.isInvincible = false;
                    }, 5000); 
                }

                if (pUp.x + pUp.width < 0) {
                    powerUps.splice(i, 1); 
                }
            }
        }
        
        function createBackgroundPatternTile(){if(bgImg.complete&&bgImg.naturalWidth>0){bgPatternCanvas=document.createElement("canvas");bgPatternCanvas.width=backgroundTileWidth;bgPatternCanvas.height=backgroundTileHeight;const e=bgPatternCanvas.getContext("2d");e.drawImage(bgImg,0,0,backgroundTileWidth,backgroundTileHeight)}else bgPatternCanvas=null}
        
        function createActualPattern(){ 
            if(bgPatternCanvas && bgCtx) {
                backgroundPattern=bgCtx.createPattern(bgPatternCanvas,"repeat");
            } else {
                backgroundPattern=null;
            }
        }

        function drawScrollingFullScreenBackground(){ 
            if(!bgCtx) return;
            bgCtx.clearRect(0,0,backgroundCanvas.width,backgroundCanvas.height);
            if(backgroundPattern&&bgPatternCanvas){
                bgCtx.save();
                bgCtx.globalAlpha=.1;
                let e=backgroundOffsetX%bgPatternCanvas.width;
                e>0&&(e-=bgPatternCanvas.width);
                bgCtx.translate(e,0);
                bgCtx.fillStyle=backgroundPattern;
                bgCtx.fillRect(0,0,backgroundCanvas.width+bgPatternCanvas.width,backgroundCanvas.height); 
                bgCtx.restore();
            } else if(bgImg.complete&&bgImg.naturalWidth>0){
                if(!bgPatternCanvas) createBackgroundPatternTile();
                if(bgPatternCanvas&&!backgroundPattern) createActualPattern();
                if(backgroundPattern&&bgPatternCanvas){
                    bgCtx.save();
                    bgCtx.globalAlpha=.1;
                    let e=backgroundOffsetX%bgPatternCanvas.width;
                    e>0&&(e-=bgPatternCanvas.width);
                    bgCtx.translate(e,0);
                    bgCtx.fillStyle=backgroundPattern;
                    bgCtx.fillRect(0,0,backgroundCanvas.width+bgPatternCanvas.width,backgroundCanvas.height);
                    bgCtx.restore();
                }else{
                    bgCtx.save();
                    bgCtx.globalAlpha=.1;
                    bgCtx.drawImage(bgImg,0,0,backgroundCanvas.width,backgroundCanvas.height);
                    bgCtx.restore();
                }
            }else{
                bgCtx.fillStyle=currentTheme.canvasFallbackBg;
                bgCtx.fillRect(0,0,backgroundCanvas.width,backgroundCanvas.height)
            }
        }
        
        function drawGround(){}
        function showMessage(e,t=3e3){messageBox.textContent=e;messageBox.style.display="block";setTimeout(()=>{messageBox.style.display="none"},t)}
        

        function drawHeaderPalopsee() {
            if (!headerPalopseeCtx) return;
            
            let currentHeaderImage = isDarkMode ? palopseeDarkImg : palopseeImg;

            if (currentHeaderImage.complete && currentHeaderImage.naturalWidth > 0) {
                 headerPalopseeCtx.clearRect(0, 0, headerPalopseeTargetWidth, headerPalopseeTargetHeight);
                 headerPalopseeCtx.drawImage(currentHeaderImage, 0, 0, headerPalopseeTargetWidth, headerPalopseeTargetHeight);
            } else if (palopseeImg.complete && palopseeImg.naturalWidth > 0) { 
                 headerPalopseeCtx.clearRect(0, 0, headerPalopseeTargetWidth, headerPalopseeTargetHeight);
                 headerPalopseeCtx.drawImage(palopseeImg, 0, 0, headerPalopseeTargetWidth, headerPalopseeTargetHeight);
            } else {
                 headerPalopseeCtx.fillStyle = currentTheme.canvasFallbackBg;
                 headerPalopseeCtx.fillRect(0, 0, headerPalopseeTargetWidth, headerPalopseeTargetHeight);
            }
        }


        function setGameOver() {
            gameOver = true;
            gameStarted = false;
            player.isInvincible = false; 
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            playGameOverSound(); 
            
            ctx.fillStyle = currentTheme.gameOverOverlay; 
            ctx.fillRect(0, 0, gameCanvasWidth, gameCanvasHeight); 
            ctx.font = `40px ${gameFont}`; 
            ctx.fillStyle = currentTheme.gameOverMainText; 
            ctx.textAlign = 'center';
            ctx.fillText('Game Over!', gameCanvasWidth / 2, gameCanvasHeight / 2 - 30);
            ctx.font = `20px ${gameFont}`; 
            ctx.fillStyle = currentTheme.gameOverSubText; 
            ctx.fillText(`Score: ${score}`, gameCanvasWidth / 2, gameCanvasHeight / 2 + 10);
            
            if (score > highScore) {
                highScore = score;
                localStorage.setItem(highScoreKey, highScore); 
                ctx.fillText(`New High Score! ${highScore}`, gameCanvasWidth / 2, gameCanvasHeight / 2 + 40);
            } else {
                ctx.fillText(`High Score: ${highScore}`, gameCanvasWidth / 2, gameCanvasHeight / 2 + 40);
            }

            ctx.font = `16px ${gameFont}`; 
            ctx.fillText('Tap or Press Space/Up to Restart', gameCanvasWidth / 2, gameCanvasHeight / 2 + 70);
        }

        function resetGame() {
            score = 0;
            previousScoreForSound = 0; 
            powerUpSpawnedForCurrentMilestone = false; 
            gameSpeed = 5; 
            gameOver = false;
            gameStarted = false; 
            obstacles = [];
            powerUps = []; 
            
            player.dy = 0;
            player.isJumping = false;
            player.isInvincible = false;
            
            messageBox.style.display = 'none';
            
            imagesLoaded = 0; 
            bgPatternCanvas = null; 
            backgroundPattern = null; 
            backgroundOffsetX = 0; 
            
            palopseeImg.src = ""; palopseeImg.src = palopseeImageUrl;
            palopseeDarkImg.src = ""; palopseeDarkImg.src = palopseeDarkImageUrl; 
            asteroidImg.src = ""; asteroidImg.src = asteroidImageUrl;
            alienShipImg.src = ""; alienShipImg.src = alienShipImageUrl;
            powerUpImg.src = ""; powerUpImg.src = powerUpImageUrl;
            bgImg.src = ""; bgImg.src = backgroundImageUrl;
        }
        
        function gameLoop() {
            if (gameOver) return;

            backgroundOffsetX -= gameSpeed;
            if (bgPatternCanvas && bgPatternCanvas.width > 0) {
                 if (backgroundOffsetX <= -bgPatternCanvas.width) {
                    backgroundOffsetX += bgPatternCanvas.width; 
                }
            }
            drawScrollingFullScreenBackground(); 

            ctx.clearRect(0, 0, gameCanvasWidth, gameCanvasHeight); 
            player.update();
            player.draw(); 
            handleObstacles(); 
            handlePowerUps();  
            
            ctx.font = `16px ${gameFont}`; 
            ctx.fillStyle = currentTheme.scoreText; 
            ctx.textAlign = 'left';
            ctx.fillText(`Score: ${score}`, 10, 25); 

            gameSpeed += gameSpeedIncreaseFactor; 
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function onImageLoad() {
            imagesLoaded++;
            if (this === bgImg && this.complete && this.naturalWidth > 0) {
                createBackgroundPatternTile();
                createActualPattern(); 
            }
            if ((this === palopseeImg || this === palopseeDarkImg) && palopseeImg.complete && palopseeDarkImg.complete && palopseeImg.naturalWidth > 0 && palopseeDarkImg.naturalWidth > 0) {
                 drawHeaderPalopsee(); 
            }

            if (imagesLoaded === totalImages) {
                if (!gameStarted && !gameOver) {
                    showMessage('Ready to Fly!', 2000);
                } else if (gameOver) { }
                 resizeAndRedrawAll(); 
            }
        }

        function onImageError(e) { 
            console.error("Error loading image:", e.target.src); 
            const imageName = e.target.src.split('/').pop() || 'asset';
            let corsMessage = "";
            if (e.target.src.includes("netlify.app")) { 
                corsMessage = " Check server CORS settings if this is your image.";
            }
            showMessage(`Error loading ${imageName}. Using fallback.${corsMessage}`, 7000);
            onImageLoad(); 
        }
        
        function startGameActions() {
            if (!audioInitialized) { 
                initializeAudio();
            }
            if (gameOver) { resetGame(); return; }
            if (!gameStarted && imagesLoaded === totalImages) {
                gameStarted = true;
                if (animationFrameId) cancelAnimationFrame(animationFrameId); 
                gameLoop();
            }
            player.jump();
        }

        window.addEventListener('keydown', (e) => { if ((e.code === 'Space' || e.code === 'ArrowUp')) { e.preventDefault(); startGameActions(); } });
        
        document.body.addEventListener('touchstart', (e) => {
            if (e.target.closest('#headerLinkContainer')) {
                return; 
            }
            e.preventDefault(); 
            startGameActions(); 
        }, { passive: false }); 

        function applyTheme(isDarkSystem) { 
            isDarkMode = isDarkSystem; 
            currentTheme = isDarkMode ? themes.dark : themes.light; 
            bodyElement.className = isDarkMode ? 'dark-theme' : 'light-theme'; 
            drawHeaderPalopsee(); 
            resizeAndRedrawAll(); 
        }
        const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        darkModeMediaQuery.addEventListener('change', (e) => applyTheme(e.matches));

        function resizeAndRedrawAll() { 
            backgroundCanvas.width = window.innerWidth;
            backgroundCanvas.height = window.innerHeight;
            if (bgImg.complete && bgImg.naturalWidth > 0) {
                 createBackgroundPatternTile();
                 createActualPattern(); 
            }
            
            let newWidth = window.innerWidth;
            let newHeight = newWidth / designAspectRatio;

            gameCanvas.width = newWidth;
            gameCanvas.height = newHeight;
            gameCanvasWidth = newWidth; 
            gameCanvasHeight = newHeight;

            player.groundY = gameCanvas.height - groundHeight - player.height; 
            if (!player.isJumping || !gameStarted) { player.y = player.groundY; }

            obstacles.forEach(obs => {
                if (obs.type === 'asteroid') {
                    obs.y = gameCanvas.height - groundHeight - obs.height; 
                } else if (obs.type === 'alienShip') {
                    const alienShipClearance = 5 + player.height * 0.2; 
                    obs.y = player.groundY - alienShipClearance - obs.height; 
                    if (obs.y < 10) obs.y = 10;
                }
            });
             powerUps.forEach(pUp => { 
                pUp.y = Math.max(player.height + 10, Math.min(pUp.y, gameCanvas.height - groundHeight - pUp.height - 10));
            });

            if (!gameStarted || gameOver) { 
                drawScrollingFullScreenBackground(); 
                ctx.clearRect(0,0,gameCanvas.width,gameCanvas.height); 
                player.draw(); 
                obstacles.forEach(o=>o.draw()); 
                powerUps.forEach(p=>p.draw());
            }

            if (!gameOver) {
                if(!gameStarted && imagesLoaded === totalImages || gameStarted) {
                    ctx.font = `16px ${gameFont}`; 
                    ctx.fillStyle = currentTheme.scoreText; 
                    ctx.textAlign = 'left';
                    ctx.fillText(`Score: ${score}`, 10, 25);
                }
            }

            if (gameOver) { 
                setGameOver(); 
            } else if (!gameStarted && imagesLoaded === totalImages) { 
                ctx.font = `20px ${gameFont}`; 
                ctx.textAlign = 'center';
                const promptText = 'Tap Screen or Press Space/Up to Start!';
                const textMetrics = ctx.measureText(promptText);
                const textWidth = textMetrics.width;
                const textHeight = parseInt(ctx.font, 10) * 1.2;

                ctx.fillStyle = currentTheme.promptBg; 
                ctx.fillRect(gameCanvas.width / 2 - textWidth / 2 - 10, gameCanvas.height / 2 - textHeight, textWidth + 20, textHeight + 10);
                ctx.fillStyle = currentTheme.promptText; 
                ctx.fillText(promptText, gameCanvas.width / 2, gameCanvas.height / 2 - textHeight / 2 + 5);

            } else if (!gameStarted && imagesLoaded < totalImages) { 
                 ctx.font = `20px ${gameFont}`; 
                 ctx.textAlign = 'center';
                 const loadingText = 'Loading Assets...';
                 const textMetricsLoading = ctx.measureText(loadingText);
                 const loadingTextWidth = textMetricsLoading.width;
                 const loadingTextHeight = parseInt(ctx.font, 10) * 1.2;

                 ctx.fillStyle = currentTheme.promptBg; 
                 ctx.fillRect(gameCanvas.width / 2 - loadingTextWidth / 2 - 10, gameCanvas.height / 2 - loadingTextHeight, loadingTextWidth + 20, loadingTextHeight + 10);
                 ctx.fillStyle = currentTheme.promptText; 
                 ctx.fillText(loadingText, gameCanvas.width / 2, gameCanvas.height / 2 - loadingTextHeight/2 + 5);
            }
             drawHeaderPalopsee(); 
        }
        
        window.addEventListener('resize', resizeAndRedrawAll);

        function initGame() {
            // Set crossOrigin for images that might cause CORS issues if you were to use getImageData
            // For simply drawing, it's often not needed if the server allows the image to be fetched.
            // palopseeImg.crossOrigin = "anonymous"; 
            // palopseeDarkImg.crossOrigin = "anonymous";
            // bgImg.crossOrigin = "anonymous"; 

            headerLink.href = customHeaderLinkUrl; 
            headerPalopseeCanvas.width = headerPalopseeTargetWidth;
            headerPalopseeCanvas.height = headerPalopseeTargetHeight;

            const savedHighScore = localStorage.getItem(highScoreKey);
            if (savedHighScore) { highScore = parseInt(savedHighScore, 10); }

            player.width = playerTargetWidth;
            player.height = playerTargetHeight;
            player.groundY = gameCanvasHeight - groundHeight - player.height; 
            player.y = player.groundY; 

            palopseeImg.onload = onImageLoad;
            palopseeDarkImg.onload = onImageLoad; 
            asteroidImg.onload = onImageLoad;
            alienShipImg.onload = onImageLoad; 
            powerUpImg.onload = onImageLoad; 
            bgImg.onload = onImageLoad; 

            palopseeImg.onerror = onImageError;
            palopseeDarkImg.onerror = onImageError; 
            asteroidImg.onerror = onImageError;
            alienShipImg.onerror = onImageError;
            powerUpImg.onerror = onImageError; 
            bgImg.onerror = onImageError; 

            palopseeImg.src = palopseeImageUrl;
            palopseeDarkImg.src = palopseeDarkImageUrl; 
            asteroidImg.src = asteroidImageUrl;
            alienShipImg.src = alienShipImageUrl;
            powerUpImg.src = powerUpImageUrl; 
            bgImg.src = backgroundImageUrl; 
            
            applyTheme(darkModeMediaQuery.matches); 
        }

        initGame(); 
    </script>
</body>
</html>
